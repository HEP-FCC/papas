Papas Physics Debug Output
==========================

# Contents:

* [Overview](#overview)
* [Introduction](#introduction)
* [Updating Physics Key Steps](#updating_physics_key_steps)
* [Updating HEPPY](#updating_heppy)
* [Updating PAPAS_CPP standalone](#updating_papas_cpp-in-fccsw)
* [Updating PAPAS in FCCSW](#updating-papas-in-fccsw)

## Overview

PhysicsDebug is a tool that allows extended physics outputs to be generated by Papas in python and in cpp. The physics outputs documents the particles, clusters, tracks etc that are created, together with the key steps in particle reconstruction. It is intended for debugging and to ensure matching outputs from cpp and python versions.

## Introduction

PDebug allows verification that the Heppy, standalone and FCCSW Papas algorithms give the same results as each other. It also ensures that the physics has not been accidentally changed by a code update.
There are two PDebug tests included in papas, one for CMS and one for Clic.

Important Notes:

* It is imperative that the random numbers produced are the same on all systems and start with a fixed seed. This is currently the case - but if it was changed would cause differences in outputs.
* Whenever papas physics is enhanced in the Python version, some updates will be needed - see below
* It may be appropriate to extend the tests in the future (eg as more physics is added to Papas) in order to ensure that the cpp and python codes produce identical results.

## Updating Physics Key Steps

When Heppy papas physics is enhanced, tests will need to updated and also propagated through to Papas cpp.

FCCSW should normally automatically pick up any changes via the Papas library installation. The main changes needed are therefore

* Heppy:      Update the pdebug reference output files in  $HEPPY/test/data/
* Papas_cpp:  Update the pdebug reference output files in Papas_cpp: $FCCPAPASCPP/data/
* Papas_cpp:  Update the papas code until the tests run OK
* FCCSW:      Rebuild FCCSW with new papas and check the FCCSW tests.


## Updating HEPPY

If a new physics feature is added to Heppy then it is likely that the pdebug test(s) will fail :-

	test_analysis_pdebug_clic.py
	test_analysis_pdebug_cms.py

The tests work by running Heppy with PDebug turned on. The output produced is then compared to an existing file, eg using
```
os.system("source $HEPPY/test/data/pdebug_python_check.sh  physics_clic.txt $HEPPY/test/data/required_clic_physics_dd.txt")
os.system("source $HEPPY/test/data/pdebug_python_check.sh  physics_cms.txt $HEPPY/test/data/required_cms_physics.txt”)
```
The pdebug_python_check.sh script carries out a comparison of the newly produced output with the required output file.

Therefore to update the test, following physics changes, the latest versions of the two output files

	physics_clic.txt
	physics_cms.txt

will need to be located and moved to

	 $HEPPY/test/data/

and renamed appropriately.

The same files should also be moved to the papas_cpp data directory (see below).

## Updating PAPAS_CPP standalone

The tests are included in examples/CMakelist.txt:-
```
add_test(NAME test_debug_cms COMMAND /bin/bash $ENV{FCCPAPASCPP}/data/pdebug_CMS.sh WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}  )
set_tests_properties(test_debug_cms PROPERTIES PASS_REGULAR_EXPRESSION "compare.out matches")
add_test(NAME test_debug_clic COMMAND /bin/bash $ENV{FCCPAPASCPP}/data/pdebug_CLIC.sh WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}  )
set_tests_properties(test_debug_clic PROPERTIES PASS_REGULAR_EXPRESSION "compare.out matches")
```

Either:

(1) Run from command line
```
	 ./example_debug filename detector logname
where
    filename = root file containing pythia generated particles and
    detector = either “CLIC” or “CMS”
    logname  = file which pdebug will write to
```
(2) Run example_debug_python_comparer.cpp from within XCode.

For CLIC, the input file should be:  ee_Z_ddbar.root. The output file (logname) needs to be compared to the required_clic_physics_dd.txt

For CMS the input file should be  ee_ZH_Zmumu_Hbb.root which should be compared with required_cms_physics.txt

For either of the above, a manual comparison of the output is needed. On a Mac,  opendiff is a nice comparison tool.

If there is a difference in physics output, the first place of difference typically points to where a change needs to be made. For example if it occurs when making the first  smearedCluster for an HCAL this gives a clear pointer. In Xcode its easy to pinpoint the locations where PDebug output is produced. For example search on  ‘“Made’.


## Updating PAPAS in FCCSW

The updates to papas are automatically included in the FCCSW when it is compiled. Once Papas_cpp passes its tests, the FCCSW tests should also be automatically OK. Any exception to this may indicate that one or more of the default detector parameters are no longer correctly set. For this it would be useful to check the default parameters set in the header files in

Sim/SimPapas/src/CMSDetector
Sim/SimPapas/src/ClicDetector

The two pdebug tests run in FCCSW are called:
```
Sim/SimPapas/scripts/pdebug_CLIC.sh
Sim/SimPapas/scripts/pdebug_CMS.sh
```
These run papas in FCCSW and then compare the outputs. For example. the key commands in the above are:-
```
MATCHPHYSICS=$FCCPAPASCPP/data/required_cms_physics.txt
ROOTFILE=$FCCPAPASCPP/data/ee_ZH_Zmumu_Hbb.root
./run fccrun.py   Sim/SimPapas/options/simple_CMS.py -r $ROOTFILE
diff $MATCHPHYSICS $PHYSICS  >  $FILE
```
